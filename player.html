<img src="" id="frame" height="480px" width="600px">
<pre id="user"></pre>
<button onclick="register();">connect to game</button>
<pre id="msgs">




</pre>
<input type="horrible" id="monkey">
<pre id="info_frames">0</pre>
<pre id="info_time">0</pre>
<pre id="info_drop">0 dropped</pre>
<script>
	var ws = new WebSocket("ws://localhost:3000/ws");
	let frames = 0;
	let drop = 0;
	let screenData = [];
	setInterval(function () {
		document.getElementById("info_frames").textContent = frames+"fps";
		frames = 0;
	}, 1000);

	function register() {
		ws.send(JSON.stringify({
			"type": "mode",
			"mode": "player"
		}));
	};
	document.addEventListener("keydown", function (event) {
		if(ws.readyState != 1) return;
		ws.send(JSON.stringify({
			type: "keypress",
			mode: "keydown",
			code: event.keyCode
		}));
	});
	document.addEventListener("keyup", function (event) {
		if(ws.readyState != 1) return;
		ws.send(JSON.stringify({
			type: "keypress",
			mode: "keyup",
			code: event.keyCode
		}));
	});
	document.getElementById("monkey").addEventListener("keydown", function (e) {
		if (e.key == "Enter" && document.getElementById("monkey").value != "" && document.getElementById("monkey").value.length < 255) {
			ws.send(JSON.stringify({
				type: "message",
				message: document.getElementById("monkey").value
			}));
			document.getElementById("monkey").value = "";
		}
		e.stopImmediatePropagation()
	});
	ws.onmessage = (function (msg) {
		let data = JSON.parse(msg.data);
		if (data.type == "message") {
			let mgs = document.getElementById("msgs").textContent.split("\n");
			mgs.shift();
			mgs.push(data.message);
			mgs = mgs.join("\n");
			document.getElementById("msgs").textContent = mgs;
		}
		if (data.type == "screen") {
			document.getElementById("frame").src = data.screen;
			frames++;
			document.getElementById("info_time").textContent = (new Date().getTime()-data.time)+"ms";
		}
		if (data.type == "uauthCallback") {
			document.getElementById("user").textContent = data.message;
		}
		if (data.type == "drop") {
			drop++;
			document.getElementById("info_drop").textContent = drop+" dropped";
		}
	});
</script>