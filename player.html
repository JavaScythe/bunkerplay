<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
	<div class="chat-game-wrap">
    <div>
      <img src="" id="frame" class="imgwrap"/>
    </div>
	<div class="chatbox">
	<pre id="msgs">
		<pre id="user"></pre>
	</pre>
    <input class="input-box" type="horrible" id="monkey" />
	</div>
</div>
    <button class="button-red" onclick="register();">connect to game</button>
    <pre style="color:white;" id="info_frames">0</pre>
    <pre style="color:white;" id="info_time">0</pre>
    <pre style="color:white;" id="info_drop">0 dropped</pre>
  </body>
  <script>
    var ws = new WebSocket("ws://localhost:3000/ws");
    let frames = 0;
    let drop = 0;
    let screenData = [];
    setInterval(function () {
      document.getElementById("info_frames").textContent = frames + "fps";
      frames = 0;
    }, 1000);

    function register() {
      ws.send(
        JSON.stringify({
          type: "mode",
          mode: "player",
        })
      );
    }
    document.addEventListener("keydown", function (event) {
      if (ws.readyState != 1) return;
      ws.send(
        JSON.stringify({
          type: "keypress",
          mode: "keydown",
          code: event.keyCode,
        })
      );
    });
    document.addEventListener("keyup", function (event) {
      if (ws.readyState != 1) return;
      ws.send(
        JSON.stringify({
          type: "keypress",
          mode: "keyup",
          code: event.keyCode,
        })
      );
    });
    document.getElementById("monkey").addEventListener("keydown", function (e) {
      if (
        e.key == "Enter" &&
        document.getElementById("monkey").value != "" &&
        document.getElementById("monkey").value.length < 255
      ) {
        ws.send(
          JSON.stringify({
            type: "message",
            message: document.getElementById("monkey").value,
          })
        );
        document.getElementById("monkey").value = "";
      }
      e.stopImmediatePropagation();
    });
    ws.onmessage = function (msg) {
      let data = JSON.parse(msg.data);
      if (data.type == "message") {
		let mgs = document.getElementById("msgs").textContent;
		mgs += (data.message);
		mgs += "\n";
		document.getElementById("msgs").textContent = mgs;
		if (document.getElementById("msgs").scrollHeight > document.getElementById("msgs").clientHeight) {
			document.getElementById("msgs").scrollTop = document.getElementById("msgs").scrollHeight - document.getElementById("msgs").clientHeight;
		}
		if (document.getElementById("msgs").textContent > 250) {
			document.getElementById("msgs").textContent = document.getElementById("msgs").textContent.slice(0, 250);
		}
      }
      if (data.type == "screen") {
        document.getElementById("frame").src = data.screen;
        frames++;
        document.getElementById("info_time").textContent =
          new Date().getTime() - data.time + "ms";
      }
      if (data.type == "uauthCallback") {
        document.getElementById("user").textContent = data.message;
      }
      if (data.type == "drop") {
        drop++;
        document.getElementById("info_drop").textContent = drop + " dropped";
      }
    };
  </script>
</html>
