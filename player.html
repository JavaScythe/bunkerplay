<canvas id="frame" height="480px" width="600px"></canvas>
<pre id="user"></pre>
<button onclick="register();">connect to game</button>
<pre id="msgs">




</pre>
<input type="horrible" id="monkey">
<pre id="info_frames">0</pre>
<pre id="info_time">0</pre>
<pre id="info_drop">0 dropped</pre>
<script>
	var ws = new WebSocket("ws://localhost:3000/ws");
	let frames = 0;
	let drop = 0;
	let screenData = new Uint8ClampedArray(600*480*4);
	setInterval(function () {
		document.getElementById("info_frames").textContent = frames+"fps";
		frames = 0;
	}, 1000);

	function register() {
		ws.send(JSON.stringify({
			"type": "mode",
			"mode": "player"
		}));
	};
	document.addEventListener("keydown", function (event) {
		if(ws.readyState != 1) return;
		ws.send(JSON.stringify({
			type: "keypress",
			mode: "keydown",
			code: event.keyCode
		}));
	});
	document.addEventListener("keyup", function (event) {
		if(ws.readyState != 1) return;
		ws.send(JSON.stringify({
			type: "keypress",
			mode: "keyup",
			code: event.keyCode
		}));
	});
	document.getElementById("monkey").addEventListener("keydown", function (e) {
		if (e.key == "Enter" && document.getElementById("monkey").value != "" && document.getElementById("monkey").value.length < 255) {
			ws.send(JSON.stringify({
				type: "message",
				message: document.getElementById("monkey").value
			}));
			document.getElementById("monkey").value = "";
		}
		e.stopImmediatePropagation()
	});
	ws.onmessage = (function (msg) {
		let data = JSON.parse(msg.data);
		if (data.type == "message") {
			let mgs = document.getElementById("msgs").textContent.split("\n");
			mgs.shift();
			mgs.push(data.message);
			mgs = mgs.join("\n");
			document.getElementById("msgs").textContent = mgs;
		}
		if (data.type == "screen") {
			let deltas = 0;
			let start = new Date().getTime();
			for(let i in data.screen) {
				i = parseInt(i);
				screenData[i] = data.screen[i][0];
				screenData[i+1] = data.screen[i][1];
				screenData[i+2] = data.screen[i][2];
				screenData[i+3] = data.screen[i][3];
				deltas++;
			}
			console.log("deltas: "+deltas+" in "+(new Date().getTime()-start)+"ms");
			let frame = document.getElementById("frame");
			let ctx = frame.getContext("2d");
			let imgData = ctx.createImageData(600, 480);
			console.log("wle "+screenData.length+" "+	(600*480*4));
			imgData.data.set(screenData);
			ctx.putImageData(imgData, 0, 0);
			frames++;
			document.getElementById("info_time").textContent = (new Date().getTime()-data.time)+"ms";
		}
		if (data.type == "uauthCallback") {
			document.getElementById("user").textContent = data.message;
		}
		if (data.type == "drop") {
			drop++;
			document.getElementById("info_drop").textContent = drop+" dropped";
		}
	});
</script>